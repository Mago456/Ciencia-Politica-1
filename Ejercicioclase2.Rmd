#Ejercicio de clase 2:

El siguiente ejercicio busca practicar la recolección de datos, su pre procesamiento y preparación para su posterior analisis estadistico.

#Comenzamos#
Vamos a coger estos dos links y a crear una tabla que integre ambos.

* [https://en.wikipedia.org/wiki/World_Happiness_Report](https://en.wikipedia.org/wiki/World_Happiness_Report)

* [https://en.wikipedia.org/wiki/Democracy_Index](https://en.wikipedia.org/wiki/Democracy_Index)

El resultado debe ser este:

<iframe width="800" height="600" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTnkrWn6LbVFyke0hQPRaCwxdi1ESkHV-6yFP5lsrrIqiVjh0RxrowR7B_ck9DL2_QFLUxkobwV9-uv/pubhtml?gid=745636458&amp;single=true&amp;widget=true&amp;headers=false"></iframe>

Como vamos a descargar bases de datos del internet, usamos el paquete indicado para eso:
```{r}
library(htmltab)
```

Ahora sí, le indicamos al R que tome en cuenta las tablas de interés de ambos links:
```{r, echo=FALSE, eval=FALSE}
happyL="https://en.wikipedia.org/wiki/World_Happiness_Report"
happyPath='//*[@id="mw-content-text"]/div/table/tbody'
demoL="https://en.wikipedia.org/wiki/Democracy_Index"
demoPath='//*[@id="mw-content-text"]/div/table[2]/tbody'
```

Le pedimos que ahora las descargue en dos bases de datos:
```{r, echo=FALSE, eval=FALSE}

happy= htmltab(doc =happyL,
               which =happyPath,
               encoding = "UTF-8")

demo= htmltab(doc =demoL,
               which =demoPath,
               encoding = "UTF-8")
```

Exploramos las bases:
```{r, echo=FALSE, eval=FALSE}
names(happy)
names(demo)
```

Si lo deseo, por practicidad, elimino los espacios en blanco del nombre de variables de HAPPY:
```{r, echo=FALSE, eval=FALSE}
names(happy)=gsub(" ","",names(happy))
names(happy)
```
Empiezo a limpiar la base de datos DEMO, usando los comandos STR_SPLIT (permite dividir en dos un caso que tiene texto):

```{r, echo=FALSE, eval=FALSE}
install.packages("stringr")
library(stringr)
names(demo)
names(demo)=str_split(names(demo)," >>",simplify = T)[,1]
names(demo)
```

Ahora también elimino los espacios en blanco de los nombres de variables en DEMO:
```{r, echo=FALSE, eval=FALSE}
names(demo)=gsub(" ","",names(demo))
names(demo)
```

Empiezo a cambiar los nombres de las variables dentro de las bases:
```{r, echo=FALSE, eval=FALSE}
names(happy)[names(happy)=="Score"]="ScoreHappy"
names(happy)
names(demo)[names(demo)=="Score"]="ScoreDemo"
names(demo)
```

También puedo eliminar variables:

```{r, echo=FALSE, eval=FALSE}
names(happy)
happy$Overallrank=NULL
names(happy)

names(demo)
demo$Rank=NULL
names(demo)
```

Podemos también explorar cómo se distribuyen los casos de ambas bases de datos:
```{r, echo=FALSE, eval=FALSE}
str(demo)
str(happy)
```

Espacios en blanco:
```{r, echo=FALSE, eval=FALSE}
demo$Country=trimws(demo$Country,whitespace = "[\\h\\v]")
demo$Regimetype=trimws(demo$Regimetype,whitespace = "[\\h\\v]")
happy$Countryorregion=trimws(happy$Countryorregion,whitespace = "[\\h\\v]")
```

También se puede ordenar una variable como ordinal:

```{r, echo=FALSE, eval=FALSE}
library(dplyr)

names(demo)
demo$Regimetype
demo$Regimetype= recode(demo$Regimetype,
       'Full democracy'='4FullDemocracy',
       'Flawed democracy'='3FlawedDemocracy',
       'Hybrid regime'='2Hybrid regime',
       'Authoritarian'='1Authoritarian')
demo$Regimetype

# poner numero delante, ayuda a crear una ordinal
demo$Regimetype=as.ordered(demo$Regimetype)
demo$Regimetype
```
Fusionando bases de datos por una variable en común:

```{r, echo=FALSE, eval=FALSE}
names(demo)
names(happy)
demohappy=merge(demo,happy,by.x = "Country",by.y = "Countryorregion")
```

Explorando la nueva base de datos creada:
```{r, echo=FALSE, eval=FALSE}
str(demohappy)
```

Notamos que algunas variables que son númericas están siendo leídas como texto. Por tanto, se usa el siguiente comando:
```{r, echo=FALSE, eval=FALSE}
demohappy[,-c(1,8,9)]=lapply(demohappy[,-c(1,8,9)],as.numeric)
str(happy)
```


Al resultado anterior, añadiremos una última tabla de este sitio web:

```{r, echo=FALSE, eval=FALSE}
url2 = "https://www.cia.gov/library/publications/resources/the-world-factbook/fields/349.html"

urban = htmltab(doc = url2, 
                which ='//*[@id="fieldListing"]',
                encoding = "UTF-8")
```

Explorando la nueva data
```{r, echo=FALSE, eval=FALSE}
names(urban)
str(urban)
```

Notamos que está muy sucia la data. Hay que limpiarla: creamos un patrón, el cual nos permita separar el texto en dos columnas. 
```{r, echo=FALSE, eval=FALSE}
PATRON="(\\-*\\d+\\.*\\d*)(?=\\%)"
COLSUCIA=urban$Urbanization

# UNA COLUMNA
urban$pop_urb=str_extract_all(string = COLSUCIA,pattern=PATRON,simplify = T)[,1]

# OTRA COLUMNA
urban$rate_urb=str_extract_all(string = COLSUCIA,pattern=PATRON,simplify = T)[,2]
```

Eliminamos la variable que ya no nos sirve
```{r}
urban$Urbanization=NULL
str(urban)
```

Notamos que las nuevas dos variables creadas no están reconocidas como numéricas:

```{r, echo=FALSE, eval=FALSE}
str(urban)
urban[,c(2,3)]=lapply(urban[,c(2,3)],as.numeric)
```

Espacios en blanco:
```{r, echo=FALSE, eval=FALSE}
urban$Country=trimws(urban$Country,whitespace = "[\\h\\v]")
```

#AHORA SI UNIMOS LAS TRES BASES DE DATOS
```{r, echo=FALSE, eval=FALSE}
demohappyurban=merge(demohappy,urban)
```

Al resultado anterior, añadale la tabla de este sitio web:

```{r, echo=FALSE, eval=FALSE}
url3 = "https://www.cia.gov/library/publications/resources/the-world-factbook/fields/274.html"
cdio= htmltab(doc = url3,
               which ='//*[@id="fieldListing"]',
               encoding = "UTF-8")
```
Explorando la nueva base de datos
```{r, echo=FALSE, eval=FALSE}
names(cdio)
str(cdio)
```

Cambiamos el nombre de la segunda variable que es larguísimo:
```{r, echo=FALSE, eval=FALSE}
#Cambiamos nombre de las variables:
names(cdio)
names(cdio)[2] = "co2"
names(cdio)
```

Empezamos a limpiar la variable CO2 que tiene mucho texto. Lo dividimos con str_split
```{r, echo=FALSE, eval=FALSE}
cdio$co2=str_split(cdio$co2,
                   pattern = '\\(',
                   simplify = T)[,1]
```

Ahora usaremos el PARSE para recuperar números de tanto texto:
```{r, echo=FALSE, eval=FALSE}
install.packages("readr")
library(readr)
cdio$co2_number=parse_number(cdio$co2)
names(cdio) #vemos que se ha creado una nueva variable con lo resumido
str(cdio)
```

Separas en otra variable los millones:
```{r, echo=FALSE, eval=FALSE}
cdio$co2_unit=str_split(cdio$co2,pattern = ' ',
                   simplify = T)[,2]

```

Vamos a pedir que detalle qué contenidos hay en la variable de millones, contabilizando también si hay algun NA:
```{r, echo=FALSE, eval=FALSE}
table(cdio$co2_unit,useNA ='always')
```

AHora que ya sabemos cuantos elementos hay en la variable de millones, vamos a recodificarla:
```{r, echo=FALSE, eval=FALSE}
#recodificando
library(dplyr)
cdio$co2_unit=recode(cdio$co2_unit,'billion'=10^9,'million'=10^6,'Mt'=1)
str(cdio)
cdio$co2_unit
```

Creamos un nuevo valor para simplificar los millones usando ambas variales creadas:
```{r, echo=FALSE, eval=FALSE}
# nuevo valor
cdio$co2_InMillions=(cdio$co2_number*cdio$co2_unit)/(10^6)
cdio$co2_InMillions
```

Verificando:
```{r, echo=FALSE, eval=FALSE}
str(cdio)
```

Me quedo con las dos variables que necesito:
```{r, echo=FALSE, eval=FALSE}
cdio$Country=trimws(cdio$Country,whitespace = "[\\h\\v]")
cdio=cdio[,c(1,5)]
str(cdio)
```

Finalmente unifico todas las bases de datos:
```{r, echo=FALSE, eval=FALSE}
demohappyurbancdio=merge(demohappyurban,cdio)
```

FIN



